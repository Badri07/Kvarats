<div class=" p-4 bg-white rounded-lg shadow-md border border-gray-100">
  <!-- Client Selector -->
  <div class="mb-5">
    <label class="block text-sm font-medium text-gray-700 mb-1">Select Client</label>
    <div class="relative">
      <select 
        (change)="onClientChangeEvent($event)"
        class="block w-96 pl-3 pr-8 py-2 text-sm rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-primary-orange focus:border-primary-orange transition-colors"
      >
        <option value="">-- Choose a Client --</option>
        <option *ngFor="let c of clients" [value]="c.id">{{ c.name }}</option>
      </select>
      <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingMenus" class="flex items-center justify-center py-3">
    <div class="animate-spin h-4 w-4 border-2 border-primary-orange border-t-transparent rounded-full mr-2"></div>
    <span class="text-sm text-gray-600">Loading menus...</span>
  </div>

  <!-- Menu Groups - Two Column Layout -->
  <div *ngIf="!loadingMenus && groupedMenus.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <ng-container *ngFor="let group of groupedMenus; let i = index; trackBy: trackByGroupIndex">
      <div *ngIf="i % 2 === 0" class="space-y-4">
        <!-- First Column Group -->
        <div class="border border-gray-200 rounded-md overflow-hidden">
          <div class="flex items-center px-3 py-2 bg-primary-orange/10 border-b border-primary-orange/20">
            <input
              type="checkbox"
              class="h-4 w-4 text-primary-orange rounded border-gray-300 focus:ring-primary-orange"
              [checked]="selectedMenuIds.includes(group.parent.Id.toString())"
              [indeterminate]="isParentIndeterminate(group)"
              (change)="toggleParent(group, $event)"
            />
            <span class="ml-2 text-sm font-semibold text-primary-orange">{{ group.parent.Name }}</span>
          </div>
          <div class="divide-y divide-gray-100">
            <div 
              *ngFor="let child of group.children; trackBy: trackByMenuId"
              class="px-3 py-2 hover:bg-gray-50 border-b last:border-b-0"
            >
              <div class="flex items-center">
                <input
                  type="checkbox"
                  class="h-4 w-4 text-primary-orange rounded border-gray-300 focus:ring-primary-orange"
                  [checked]="selectedMenuIds.includes(child.Id.toString())"
                  (change)="toggleMenu(child.Id, $event)"
                  id="menu-{{child.Id}}"
                />
                <label for="menu-{{child.Id}}" class="ml-2 text-sm text-gray-700 flex-1">{{ child.Name }}</label>
              </div>

              <!-- Role checkboxes for this menu -->
              <div class="mt-1 ml-6 flex flex-wrap gap-2">
                <label *ngFor="let role of roles; trackBy: trackByRoleId" class="inline-flex items-center text-xs text-gray-600 cursor-pointer">
                  <input
                    type="checkbox"
                    class="h-3 w-3 text-primary-orange rounded border-gray-300 focus:ring-primary-orange"
                    [checked]="menuRoleSelections[child.Id.toString()].includes(role.id.toString())"
                    (change)="toggleRole(child.Id.toString(), role.id.toString(), $event)"
                    [disabled]="!selectedMenuIds.includes(child.Id.toString())"
                  />
                  <span class="ml-1">{{ role.roleName }}</span>
                </label>
              </div>

            </div>
          </div>
        </div>

        <!-- Second Column Group (if exists) -->
        <div *ngIf="groupedMenus[i+1]" class="border border-gray-200 rounded-md overflow-hidden">
          <div class="flex items-center px-3 py-2 bg-primary-orange/10 border-b border-primary-orange/20">
            <input
              type="checkbox"
              class="h-4 w-4 text-primary-orange rounded border-gray-300 focus:ring-primary-orange"
              [checked]="selectedMenuIds.includes(groupedMenus[i+1].parent.Id.toString())"
              [indeterminate]="isParentIndeterminate(groupedMenus[i+1])"
              (change)="toggleParent(groupedMenus[i+1], $event)"
            />
            <span class="ml-2 text-sm font-semibold text-primary-orange">{{ groupedMenus[i+1].parent.Name }}</span>
          </div>
          <div class="divide-y divide-gray-100">
            <div *ngFor="let child of groupedMenus[i+1].children; trackBy: trackByMenuId" class="px-3 py-2 hover:bg-gray-50">
              <div class="flex items-center">
                <input
                  type="checkbox"
                  class="h-4 w-4 text-primary-orange rounded border-gray-300 focus:ring-primary-orange"
                  [checked]="selectedMenuIds.includes(child.Id.toString())"
                  (change)="toggleMenu(child.Id, $event)"
                  id="menu-{{child.Id}}"
                />
                <label for="menu-{{child.Id}}" class="ml-2 text-sm text-gray-700 flex-1">{{ child.Name }}</label>
              </div>
              <!-- Role checkboxes -->
              <div class="mt-1 ml-6 flex flex-wrap gap-2">
                <label
                  *ngFor="let role of roles; trackBy: trackByRoleId"
                  class="inline-flex items-center space-x-1 text-xs cursor-pointer select-none"
                >
                  <input
                    type="checkbox"
                    class="h-3 w-3 text-primary-orange rounded border-gray-300 focus:ring-primary-orange"
                    [checked]="menuRoleSelections[child.Id.toString()].includes(role.id.toString())"
                    (change)="toggleRole(child.Id.toString(), role.id.toString(), $event)"
                    [disabled]="!selectedMenuIds.includes(child.Id.toString())"
                  />
                  <span>{{ role.roleName }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loadingMenus && groupedMenus?.length === 0" class="py-4 text-center">
    <svg class="mx-auto h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <p class="mt-1 text-sm text-gray-500">No menus available for this client</p>
  </div>

  <!-- Save Button -->
  <div *ngIf="selectedClientId && !loadingMenus && groupedMenus.length > 0" class="mt-6">
    <button
      (click)="saveAccess()"
      [disabled]="saving"
      class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-orange hover:bg-orange-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-orange disabled:opacity-70 disabled:cursor-not-allowed transition-colors"
    >
      <span *ngIf="!saving">Save Access</span>
      <span *ngIf="saving" class="flex items-center justify-center">
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
      </span>
    </button>
  </div>
</div>
