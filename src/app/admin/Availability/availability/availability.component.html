<div class="dashboard-container container">
  <div class="animated-tabs">
    <div class="slider"></div>
    <div class="tab" [class.active]="selectedTab === 'existing-availability'" (click)="setTab('existing-availability')">
      <i class="fas fa-calendar-days"></i>
      <span>Availability List</span>
    </div>

    <div class="tab" [class.active]="selectedTab === 'availability'" (click)="setTab('availability')">
      <i class="fas fa-plus-circle"></i>
      <span>Add Availability</span>
    </div>

    <div class="tab" [class.active]="selectedTab === 'list-leave'" (click)="setTab('list-leave')">
      <i class="fas fa-calendar-check"></i>
      <span>Leave List</span>
    </div>

    <div class="tab" [class.active]="selectedTab === 'leave'" (click)="setTab('leave')">
      <i class="fas fa-plus-circle"></i>
      <span>Add Leave</span>
    </div>
  </div>

<!-- Availability Form -->
<div *ngIf="selectedTab === 'availability'" class="card-wrapper mb-4">
  <div class="card-body mt-4">
    <h3 class="card-title">{{ isEditMode ? 'Update Doctor Availability' : 'Set Doctor Availability' }}</h3>
    <form [formGroup]="availabilityform" (ngSubmit)="onSubmit()">
      <div class="row mt-4">
        <div class="col-md-12 col-12">
          <label for="therapist" class="form-label">Therapist</label>
          <select [ngClass]="{
            'is-invalid': availabilitySubmitted && availabilityform.get('userId')?.invalid,
            'is-valid': availabilitySubmitted && availabilityform.get('userId')?.valid
          }" id="therapist" class="form-select" formControlName="userId">
            <option selected disabled value="">Select therapist</option>
            <option *ngFor="let list of therapistList" [value]="list.userId">
              {{ list.firstName }} {{ list.lastName }}
            </option>
          </select>
          <div *ngIf="availabilitySubmitted && availabilityform.get('userId')?.errors" class="invalid-feedback">
            <div *ngIf="availabilityform.get('userId')?.hasError('required')">
              Therapist is required
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <label class="form-label block text-orange-400 font-medium">Day of Week</label>
            <button type="button" 
        class="btn btn-sm btn-outline-primary"
        (click)="toggleAllDays()">
  {{ allDaysSelected ? 'Deselect All' : 'Select All Days' }}
</button>
          </div>
          
          <div formArrayName="days" class="day-time-container">
            <div *ngFor="let dayGroup of daysArray.controls; let i = index" 
                 [formGroupName]="i" 
                 class="day-time-row mb-3 p-3 border rounded"
                 [class.disabled-day]="dayGroup.get('hasLeave')?.value">
              
              <!-- Day Header Row -->
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="d-flex align-items-center">
                  <div class="form-check form-switch me-3">
                    <input class="form-check-input day-checkbox" 
                          type="checkbox" 
                          formControlName="enabled"
                          [id]="'dayToggle_' + i"
                          [disabled]="dayGroup.get('hasLeave')?.value"
                          (change)="toggleDay(dayGroup.get('dayId')?.value)">
                    <label class="form-check-label fw-bold" [for]="'dayToggle_' + i">
                      {{ dayOfWeek[i].name }}
                      <span *ngIf="dayGroup.get('hasLeave')?.value" 
                            class="badge bg-danger ms-2">
                        On Leave
                      </span>
                    </label>
                  </div>
                </div>
                
                <!-- Availability Toggle (only shown if day is enabled and not on leave) -->
                <div class="form-check form-switch" 
                     *ngIf="dayGroup.get('enabled')?.value && !dayGroup.get('hasLeave')?.value">
                  <input class="form-check-input" 
      type="checkbox" 
      [id]="'availableToggle_' + i"
      formControlName="isAvailable"
      (change)="onAvailabilityToggle(dayGroup)">
                  <label class="form-check-label ms-2" [for]="'availableToggle_' + i">
                    Available
                  </label>
                </div>
              </div>
              
              <!-- Time Inputs (only shown if day is enabled) -->
              <div class="row" *ngIf="dayGroup.get('enabled')?.value">
                <div class="col-md-6">
                  <label [for]="'startTime_' + i" class="form-label">
                    {{ dayGroup.get('hasLeave')?.value ? 'Leave Reason' : 'Start Time' }}
                  </label>
                  
                  <!-- Regular time input for available days -->
                  <input *ngIf="!dayGroup.get('hasLeave')?.value"
      type="time" 
      [id]="'startTime_' + i"
      class="form-control" 
      formControlName="startTime"
      [disabled]="!dayGroup.get('enabled')?.value || !dayGroup.get('isAvailable')?.value">
                  
                  <!-- Read-only display for leave days -->
                  <input *ngIf="dayGroup.get('hasLeave')?.value"
                        type="text" 
                        class="form-control" 
                        [value]="dayGroup.get('startTime')?.value"
                        readonly>
                </div>
                
                <div class="col-md-6">
                  <label [for]="'endTime_' + i" class="form-label">
                    {{ dayGroup.get('hasLeave')?.value ? 'Leave Details' : 'End Time' }}
                  </label>
                  
                  <!-- Regular time input for available days -->
                  <input *ngIf="!dayGroup.get('hasLeave')?.value"
                        type="time" 
                        [id]="'endTime_' + i"
                        class="form-control" 
                        formControlName="endTime"
                        [disabled]="!dayGroup.get('isAvailable')?.value">
                  
                  <!-- Read-only display for leave days -->
                  <input *ngIf="dayGroup.get('hasLeave')?.value"
                        type="text" 
                        class="form-control" 
                        [value]="dayGroup.get('endTime')?.value"
                        readonly>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3 align-items-center">
        <div class="save-btn col-md-12 d-flex justify-content-end">
          <button type="submit" class="btn customBtn">
            <i class="fa-solid fa-floppy-disk me-1"></i>{{ isEditMode ? 'Update Availability' : 'Save Availability' }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

  <!-- Existing Availabilities Table -->
  <div *ngIf="selectedTab === 'existing-availability'" class="card-wrapper">
    <div class="card-body mt-4">
      <h3 class="card-title">Existing Availabilities</h3>
      <div class="mt-1">
        <div class="mt-4 rounded-xl bg-white">
          <div class="flex gap-2 justify-between mb-3">
            <div class="relative flex items-center">
              <input
                type="text"
                id="searchInput"
                class="w-full px-4 m-2 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary-border-color focus:border-transparent"
                [(ngModel)]="searchValue"
                (input)="onQuickFilterChanged()"
                placeholder="Search Therapist...">
              <button
                class="px-4 py-2 bg-gray-100 text-gray-600 border border-l-0 border-gray-300 rounded-r-lg hover:bg-primary-border-color hover:text-white transition-colors"
                *ngIf="searchValue"
                (click)="searchValue=''; onQuickFilterChanged()">
                Clear
              </button>
            </div>
            <button 
              class="flex items-center gap-2 px-2.5 py-1 border border-green-600 text-green-600 rounded-md text-sm hover:bg-green-600 hover:text-white transition"
              (click)="onExportClick()"
            >
              <i class="fas fa-file-excel text-sm"></i>
              <span>Export Excel</span>
            </button>
          </div>

          <ag-grid-angular
            class="ag-theme-alpine ag-theme-custom"
            [gridOptions]="gridOptions"
            [rowData]="rowData"
            [columnDefs]="columnDefs"
            [defaultColDef]="defaultColDef"
            [pagination]="true"
            [paginationPageSize]="paginationPageSize"
            style="width: 100%; height: 500px;">
          </ag-grid-angular>
        </div>
      </div>
    </div>
  </div>

  <!-- Leave List Table -->
  <div *ngIf="selectedTab === 'list-leave'" class="card-wrapper">
    <div class="card-body mt-4">
      <h3 class="card-title">List of Doctor Leaves</h3>
      <div class="mt-1">
        <div class="mt-4 rounded-xl bg-white">
          <div class="flex gap-2 justify-between mb-3">
            <div class="relative flex items-center">
              <input
                type="text"
                id="searchInput"
                class="w-full px-4 m-2 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary-border-color focus:border-transparent"
                [(ngModel)]="searchValue"
                (input)="onQuickFilterChanged()"
                placeholder="Search patients...">
              <button
                class="px-4 py-2 bg-gray-100 text-gray-600 border border-l-0 border-gray-300 rounded-r-lg hover:bg-primary-border-color hover:text-white transition-colors"
                *ngIf="searchValue"
                (click)="searchValue=''; onQuickFilterChanged()">
                Clear
              </button>
            </div>
            <button 
              class="flex items-center gap-2 px-2.5 py-1 border border-green-600 text-green-600 rounded-md text-sm hover:bg-green-600 hover:text-white transition"
              (click)="onExportClick()"
            >
              <i class="fas fa-file-excel text-sm"></i>
              <span>Export Excel</span>
            </button>
          </div>

          <ag-grid-angular
            class="ag-theme-alpine ag-theme-custom"
            [gridOptions]="gridOptionsLeave"
            [rowData]="rowDataLeave"
            [columnDefs]="columnDefsLeave"
            [defaultColDef]="defaultColDef"
            [pagination]="true"
            [paginationPageSize]="paginationPageSize"
            style="width: 100%; height: 500px;">
          </ag-grid-angular>
        </div>
      </div>
    </div>
  </div>

  <!-- Leave Popup Form -->
  <div class="popup-form" *ngIf="selectedTab === 'leave' && isPopupOpen">
    <div class="popup-content mt-4">
      <span class="close-btn" (click)="closePopup()"></span>
      <div class="card-body">
        <h3>{{ isEditMode ? 'Update Leave' : 'Leave Form' }}</h3>
        <form [formGroup]="Leaveform" (ngSubmit)="onSubmitLeave()">
          <div class="row mt-2">
            <div class="col-md-4 col-12">
              <div>
                <label for="therapist" class="form-label">Therapist Name</label>
                <select [ngClass]="{
                  'is-invalid': leaveUserSubmitted && leaveFormUser['therapistName'].invalid,
                  'is-valid': leaveUserSubmitted && leaveFormUser['therapistName'].valid
                }" id="therapist" class="form-select" formControlName="therapistName">
                  <option selected disabled value="">Select therapist</option>
                  <option *ngFor="let list of therapistList" [value]="list.userId">
                    {{ list.firstName }} {{ list.lastName }}
                  </option>
                </select>
                <div *ngIf="leaveUserSubmitted && leaveFormUser['therapistName']['errors']" class="invalid-feedback">
                  <div *ngIf="leaveFormUser['therapistName']['errors']['required']">
                    therapist Name is required
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 col-12">
              <div>
                <label class="form-label">Leave Date</label>
                <input type="date" class="form-control" formControlName="leaveDate" />
              </div>
            </div>
            <div class="col-md-4 col-12">
              <div>
                <label class="form-label">Reason for leave</label>
                <input class="form-control" placeholder="Enter reason" formControlName="reason">
              </div>
            </div>
          </div>

          <div class="row mt-3" *ngIf="isshowTime">
            <div class="col-md-6 col-12">
              <div>
                <label for="startTime" class="form-label">Start Time</label>
                <input type="time" id="startTime" class="form-control" formControlName="startTime" />
              </div>
            </div>
            <div class="col-6">
              <div>
                <label for="endTime" class="form-label">End Time</label>
                <input type="time" id="endTime" class="form-control" formControlName="endTime" />
              </div>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-6">
              <input type="checkbox" id="isfullday" formControlName="isfullday" (change)="onFullDayToggle()" />
              <label class="form-check-label" for="isfullday">Full day</label>
            </div>
            <div class="col-6">
              <div class="save-btn" style="display: flex; justify-content: right;">
                <button type="submit" class="customBtn">
                  <i class="fa-solid fa-floppy-disk me-1"></i>
                  {{ isEditMode ? 'Update Leave' : 'Save Leave' }}
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>